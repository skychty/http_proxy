global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 100000

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3

# 统计页面（可选）
listen stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# HTTPS代理服务负载均衡
frontend https_proxy_frontend
    bind *:9222
    mode tcp
    default_backend https_proxy_backend

backend https_proxy_backend
    mode tcp
    # balance roundrobin  # 轮询算法
    balance leastconn  # 最少连接算法（推荐）
    # balance source     # 源IP哈希算法（保持会话）
    
    # 健康检查配置
    # 使用简单的连接检查，避免干扰 PROXY Protocol
    # 注意：如果使用 send-proxy-v2，健康检查连接也会发送 PROXY Protocol
    # 但健康检查连接可能会立即关闭，服务器端已优雅处理这种情况
    option tcp-check
    
    # 后端服务器列表
    # 注意：send-proxy-v2 用于真实客户端连接传递真实IP
    # 健康检查连接可能不发送 PROXY Protocol，服务器端已优雅处理
    server inst-443 127.0.0.1:443 check inter 2000 fall 3 rise 2 send-proxy-v2
    server inst-444 127.0.0.1:444 check inter 2000 fall 3 rise 2 send-proxy-v2

